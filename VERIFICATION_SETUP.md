# 防伪验证码系统说明

## ✅ 已完成的功能

### 1. 验证码数据库表
- 创建了 `verification_codes` 表存储所有验证码
- 支持验证码状态管理（active, used, revoked）
- 记录验证次数和验证时间

### 2. 真伪验证页面 (`/verify`)
- ✅ 连接 Supabase 数据库查询验证码
- ✅ 显示验证结果（成功/失败）
- ✅ 显示商品名称、订单编号等详细信息
- ✅ 记录验证次数和验证时间
- ✅ 如果 Supabase 未配置，使用模拟验证作为后备

### 3. 自动生成验证码
- ✅ 订单创建时自动为每个商品生成验证码
- ✅ 每个商品根据数量生成对应数量的验证码
- ✅ 验证码格式：`DJ-{timestamp}-{random}-{序号}`

### 4. 后台验证码管理 (`/admin`)
- ✅ 新增"验证码管理"标签页
- ✅ 查看所有验证码列表
- ✅ 显示验证码状态、验证次数、验证时间
- ✅ 手动生成验证码功能
- ✅ 支持分页和导出 CSV

## 📋 数据库表结构

### verification_codes 表

```sql
CREATE TABLE verification_codes (
  id UUID PRIMARY KEY,
  code TEXT UNIQUE NOT NULL,           -- 验证码（唯一）
  product_id TEXT,                     -- 商品 ID
  product_name TEXT,                   -- 商品名称
  order_number TEXT,                   -- 订单编号
  status TEXT DEFAULT 'active',        -- 状态：active, used, revoked
  verified_at TIMESTAMP,               -- 最后验证时间
  verified_count INTEGER DEFAULT 0,    -- 验证次数
  created_at TIMESTAMP DEFAULT NOW()   -- 创建时间
);
```

## 🔄 工作流程

### 1. 订单创建时
- 用户完成结账
- 系统自动为订单中的每个商品生成验证码
- 每个商品根据购买数量生成对应数量的验证码
- 验证码保存到 Supabase 数据库

### 2. 验证流程
- 用户输入验证码
- 系统查询 Supabase 数据库
- 检查验证码是否存在且状态为 `active`
- 如果有效，更新验证次数和验证时间
- 显示验证结果和详细信息

### 3. 后台管理
- 管理员可以查看所有验证码
- 可以手动生成验证码（用于线下销售等场景）
- 可以查看验证码的使用情况

## 🚀 使用方式

### 1. 设置数据库

在 Supabase SQL Editor 中执行 `SUPABASE_SETUP.md` 中的 SQL 创建表。

### 2. 自动生成验证码

订单创建时会自动生成，无需手动操作。

### 3. 手动生成验证码

1. 登录后台管理系统 (`/admin/login`)
2. 切换到"验证码管理"标签页
3. 点击"生成验证码"按钮
4. 输入商品名称和生成数量
5. 点击"生成"即可批量创建验证码

### 4. 验证验证码

1. 访问 `/verify` 页面
2. 输入商品上的防伪验证码
3. 点击"查询"按钮
4. 查看验证结果

## 📊 验证码格式

格式：`DJ-{timestamp}-{random}-{序号}`

示例：
- `DJ-1704067200000-A3B5C7D9-1`
- `DJ-1704067200000-X9Y8Z7W6-2`

说明：
- `DJ`：固定前缀（大甲镇澜宫）
- `{timestamp}`：时间戳
- `{random}`：8位随机字符
- `{序号}`：同一订单中的序号

## 🔒 安全特性

1. **唯一性**：每个验证码在数据库中唯一
2. **状态管理**：支持 active/used/revoked 状态
3. **验证记录**：记录验证次数和验证时间
4. **防重复验证**：可以追踪验证码的使用情况

## ⚠️ 注意事项

1. **Supabase 配置**：需要配置 Supabase 才能使用完整功能
2. **RLS 策略**：确保设置了正确的 Row Level Security 策略
3. **验证码安全**：验证码生成后应妥善保管，避免泄露

## 🔧 后续优化建议

1. **QR Code 扫描**：添加二维码扫描功能
2. **批量导入**：支持从 Excel 批量导入验证码
3. **验证码撤销**：在后台可以撤销验证码
4. **验证统计**：添加验证码使用统计图表
5. **邮件通知**：验证成功时发送邮件通知
