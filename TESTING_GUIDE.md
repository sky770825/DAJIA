# 测试指南

## 🧪 验证码系统测试步骤

### 前置条件

1. **确保 Supabase 已配置**
   - 检查 `.env.local` 文件是否包含 Supabase 配置
   - 确保已执行 `SUPABASE_SETUP.md` 中的 SQL 创建表

2. **确保开发服务器运行**
   - 访问 http://localhost:8080 确认网站正常运行

### 测试场景 1：订单创建自动生成验证码

1. **创建测试订单**
   - 访问首页，选择商品加入购物车
   - 进入购物车页面 (`/cart`)
   - 点击"前往结账"
   - 填写收货信息并提交订单

2. **检查验证码生成**
   - 登录后台管理系统 (`/admin/login`)
   - 切换到"验证码管理"标签页
   - 查看是否有新生成的验证码
   - 验证码应该关联到订单编号

3. **验证验证码格式**
   - 验证码格式应为：`DJ-{timestamp}-{random}-{序号}`
   - 每个商品应该根据数量生成对应数量的验证码

### 测试场景 2：真伪验证功能

1. **使用有效验证码**
   - 从后台复制一个验证码
   - 访问 `/verify` 页面
   - 输入验证码并点击"查询"
   - 应该显示"验证成功"
   - 应该显示商品名称、订单编号等信息
   - 验证次数应该增加

2. **使用无效验证码**
   - 输入一个不存在的验证码（如：`DJ-TEST-12345`）
   - 应该显示"查无此序号"
   - 应该提示联系客服

3. **重复验证**
   - 使用同一个验证码多次验证
   - 每次验证后，验证次数应该增加
   - 验证时间应该更新为最新验证时间

### 测试场景 3：后台手动生成验证码

1. **生成验证码**
   - 登录后台管理系统
   - 切换到"验证码管理"标签页
   - 点击"生成验证码"按钮
   - 输入商品名称（如：`媽祖金箔護身符`）
   - 输入生成数量（如：`5`）
   - 点击"生成"

2. **检查生成的验证码**
   - 在验证码列表中查看新生成的验证码
   - 验证码状态应为 `active`
   - 商品名称应正确显示

3. **使用生成的验证码**
   - 复制一个生成的验证码
   - 在 `/verify` 页面验证
   - 应该验证成功

### 测试场景 4：无 Supabase 配置的情况

1. **模拟无 Supabase**
   - 临时移除 `.env.local` 中的 Supabase 配置
   - 重启开发服务器

2. **测试验证功能**
   - 访问 `/verify` 页面
   - 输入以 `DJ` 开头的验证码
   - 应该使用模拟验证（显示成功）
   - 输入其他验证码应显示失败

3. **测试订单创建**
   - 创建订单应该仍然可以完成
   - 验证码会保存到 localStorage 作为备份

### 测试场景 5：数据导出

1. **导出验证码**
   - 在后台"验证码管理"标签页
   - 点击"匯出 CSV"按钮
   - 检查下载的 CSV 文件
   - 应该包含所有验证码信息

### 测试场景 6：分页功能

1. **测试分页**
   - 如果验证码数量超过 10 个
   - 应该显示分页控件
   - 点击"上一頁"和"下一頁"应该正常工作
   - 切换标签页时应该重置到第一页

## 🐛 常见问题排查

### 问题 1：验证码查询失败

**可能原因：**
- Supabase 未配置或配置错误
- 数据库表未创建
- RLS 策略设置不正确

**解决方法：**
1. 检查 `.env.local` 文件
2. 确认 Supabase 项目 URL 和 Key 正确
3. 检查 Supabase Dashboard 中表是否存在
4. 检查 RLS 策略是否正确设置

### 问题 2：订单创建后没有生成验证码

**可能原因：**
- Supabase 未配置
- 数据库插入失败
- 验证码生成逻辑错误

**解决方法：**
1. 检查浏览器控制台是否有错误
2. 检查 Supabase Dashboard 的 Logs
3. 确认 `verification_codes` 表已创建
4. 检查订单是否成功创建

### 问题 3：后台无法查看验证码

**可能原因：**
- RLS 策略限制
- Supabase 配置错误
- 查询权限不足

**解决方法：**
1. 检查 RLS 策略是否允许读取
2. 确认使用正确的 Supabase key
3. 检查 Supabase Dashboard 的 Logs

### 问题 4：验证码格式不正确

**可能原因：**
- 生成逻辑有误
- 时间戳或随机数生成问题

**解决方法：**
1. 检查验证码生成代码
2. 确认格式符合预期
3. 检查是否有重复的验证码

## 📝 测试检查清单

- [ ] Supabase 配置正确
- [ ] 数据库表已创建
- [ ] 订单创建时自动生成验证码
- [ ] 验证码格式正确
- [ ] 真伪验证功能正常
- [ ] 验证次数正确记录
- [ ] 后台可以查看验证码
- [ ] 后台可以手动生成验证码
- [ ] 分页功能正常
- [ ] CSV 导出功能正常
- [ ] 无 Supabase 时的后备功能正常

## 🔍 调试技巧

1. **查看浏览器控制台**
   - 打开开发者工具 (F12)
   - 查看 Console 标签页
   - 检查是否有错误信息

2. **查看 Supabase Dashboard**
   - 登录 Supabase 项目
   - 查看 Table Editor 确认数据
   - 查看 Logs 检查 API 调用

3. **检查网络请求**
   - 在开发者工具的 Network 标签页
   - 查看 Supabase API 请求
   - 检查请求和响应

4. **使用 localStorage**
   - 在开发者工具的 Application 标签页
   - 查看 localStorage 中的数据
   - 确认备份数据是否正确保存
